import numpy as np
import math as m
import pytest
import sys
sys.path.insert(1,sys.path[0]+"/../")
from multirate import Multirate, multirate_solve
mr_ex2_im2=Multirate(np.array([[0, 0], [2/3, 0]]),
     np.array([[1-1/np.sqrt(2), 0], [1/np.sqrt(2), 1-1/np.sqrt(2)]]),
     np.array([1/4, 3/4]),
     np.array([1/np.sqrt(2), 1-1/np.sqrt(2)]),
     lambda lam, M: np.array([[(lam-1) / M, 0], [(3*lam-1)/(3*M), 0]]),
     lambda lam, M: np.array([[M-M/np.sqrt(2) if lam == 1 else 0, 0], [1/4, 3/4]]))
mr_im2_ex2=Multirate(np.array([[1-1/np.sqrt(2), 0], [1/np.sqrt(2), 1-1/np.sqrt(2)]]), 
                     np.array([[0, 0], [2/3, 0]]), 
                     np.array([1/np.sqrt(2), 1-1/np.sqrt(2)]),np.array([1/4, 3/4]), 
                     lambda lam, M: np.array([[(2*lam-np.sqrt(2))/(2*M), 0], [1/4 if lam == M else lam / M, 3/4 if lam == M else 0]]), 
                     lambda lam, M: np.array([[0, 0], [2/3, 0]]))
mr_ex2_ex2 = Multirate(np.array([[0,0],[2/3,0]]),
                       np.array([[0,0],[2/3,0]]),
                       np.array([1/4, 3/4]),
                       np.array([1/4, 3/4]),
                       lambda lam, M: np.array([[0,0], [2/(3*M), 0]]) if lam==1 else np.array([[(3*M**3-11*M**2+20*lam*M-20*M-20*lam+20)/(20*(M-1)*M), -M*(3*M-11)/(20*(M-1))], [(-3*M**3-9*M**2+60*lam*M-20*M-60*lam+20)/(60*(M-1)*M), M*(M+3)/(20*(M-1))]]),
                       lambda lam, M: np.array([[0, 0], [-1/3*(M-2)*M if lam==1 else 0, M**2/3 if lam == 1 else 0]]))
mr_ex3_ex3 = Multirate(np.array([[0,0,0],[1/2,0,0],[0,3/4,0]]),
                       np.array([[0,0,0],[1/2,0,0],[0,3/4,0]]),
                       np.array([2/9,1/3,4/9]),
                       np.array([2/9, 1/3, 4/9]),
                       lambda lam, M: np.array([[0, 0, 0], [1/(2*M), 0, 0], [0, 3/(4*M), 0]]) if lam == 1 else np.array([[(3*M**3-8*M**2+6*lam*M-6*lam+6)/(6*(M-1)*M), (-3*M**2+8*M-6)/(6*(M-1)), 0], [(-2*M**2+6*lam*M-3*M-6*lam+3)/(6*(M-1)*M), M / (3*(M-1)), 0], [(-3*M**3+2*M**2+12*lam*M-9*M-12*lam+12)/(12*(M-1)*M), (3*M**3 - 2*M**2+6*M-9)/(12*(M-1)*M), 0]]),
                       lambda lam, M: np.array([[0, 0, 0], [-1/66*M*(16*M-33), 8*M**2/33, 0] if lam == 1 else [0, 0, 0], [1/264*(11*M**4-22*M**3+26*M**2+11*M+44), 1/88*(-11*M**4+22*M**3-16*M**2-11*M+22), 1/12*(M**4-2*M**3+M**2+M+4)] if lam == 1 else [(-M**4 + 2*M**3+2*M**2+3*M-4)/(24*(M-1)), 1/8 * (M**3-M**2-M+2), (-M**4+2*M**3-M**2+3*M-4)/(12*(M-1))]]))
mr_ex4_ex4 = Multirate(np.array([[0,0,0,0],[1/3,0,0,0],[0,5/9,0,0],[833/7680,833/9216,3213/5120,0]]),
                       np.array([[0,0,0,0],[1/3,0,0,0],[0,5/9,0,0],[833/7680,833/9216,3213/5120,0]]),
                       np.array([101/714,1/3,1/6,128/357]),
                       np.array([101/714,1/3,1/6,128/357]),
     lambda lam, M: np.array([[0,0,0,0],[1/3/M,0,0,0],
                               [5*(518*M**3-2140*M**2+2399*M-777)/(2331*M*(3*M-4)), -5*(518*M**3-2140*M**2+1622*M+259)/(2331*M*(3*M-4)), 0, 0],
                               [17*(141932*M**3-445231*M**2+481160*M-178710)/(852480*M*(3*M-4)), -17*(94535*M**3-228442*M**2+142736*M-5180)/(340992*M*(3*M-4)), 3213*M/5120, 0]]) if lam == 1 else np.array(
                                   [[(lam-1)/M,0,0,0],
                                    [(3*lam-2)/(3*M),0,0,0],[(777*(12*lam-7)+(6993*lam+12092)*M**2-5965*M**3-3*(5439*lam+286)*M)/(2331*M*(3*M**2-7*M+4)), 5*(1193*M**3-3040*M**2+1622*M+259)/(2331*M*(3*M**2-7*M+4)),0,0],[(222*(3072*lam-335)+(511488*lam+1937719)*M**2-867119*M**3-72*(16576*lam+13973)*M)/(170496*M*(3*M**2-7*M+4)), 17*(51007*M**3-119207*M**2+71368*M-2590)/(170496*M*(3*M**2-7*M+4)), 0, 0]]),
     lambda lam, M: np.array([[0,0,0,0], [M/3-34*M**2/361, 34*M**2/361, 0, 0],
                              [0, 5*(1805-981*M)*M/6498, 5*M*(327*M-361)/2166, 0],
                              [M*(1480461*M**2-3944118*M+3007130)/2772480, -119*M*(3249*M**2-20358*M+18050)/3326976, -119*M*(66063*M**2-78954*M-18050)/5544960, (M-1)*M*M]]) if lam == 1 else np.zeros((4,4)))
g3 = 1/2 * (2 + m.sqrt(6) * m.sin(1/3 * m.atan((2 * m.sqrt(2))**-1)) - m.sqrt(2) * m.cos(1/3 * m.atan(1/(2*m.sqrt(2)))))

mr_ex3_im3 = Multirate(np.array([[0,0,0], [1/2,0,0], [0,3/4,0]]),
                       np.array([[g3, 0, 0], [-2*(3*g3**3-9*g3**2 + 6*g3-1)/(3*(2*g3**2-4*g3+1)), g3, 0], [(4*g3-1)/(4 * (3*g3**3-9*g3**2+6*g3-1)), -3*(2*g3**2-4*g3+1)**2/(4*(3*g3**3-9*g3**2+6*g3-1)), g3]]),
     np.array([2/9,1/3,4/9]),
    np.array([(4*g3-1)/(4*(3*g3**3-9*g3**2+6*g3-1)), -3*(2*g3**2-4*g3+1)**2/(4*(3*g3**3-9*g3**2+6*g3-1)), g3]),
    lambda lam, M: np.array([[(lam-1)/M,0,0],
                    [(2*lam-1)/(2*M), 0, 0],
                             [(g3**3*(-60*lam+42)+g3**2*(18*M+72*lam-72)+g3*(-36*M+42*lam+3)+9*M-16*lam+4)/(16*M*(3*g3**3-9*g3**2+6*g3-1)), -9*(2*g3**2-4*g3+1)*(M+3*g3-6*g3*lam)/(16*M*(3*g3**3-9*g3**2+6*g3-1)),0]]),
    lambda lam, M: np.array([[M*g3,0,0],
                        [-M*(g3**4*(36*M-36)+g3**3*(-120*M+126)+g3**2*(108*M-138)+g3*(-36*M+51)+4*M-6)/(9*(2*g3**2-4*g3+1)**2), 4*M**2*(9*g3**4-30*g3**3+27*g3**2-9*g3+1)/(9*(2*g3**2-4*g3+1)**2), 0],
                             [2/9, 1/3, 4/9]]) if lam == 1 else np.array([[0,0,0],[0,0,0],[2/9,1/3,4/9]]))
mr_im3_ex3 = Multirate(
     np.array([[g3, 0, 0], [-2*(3*g3**3-9*g3**2 + 6*g3-1)/(3*(2*g3**2-4*g3+1)), g3, 0], [(4*g3-1)/(4 * (3*g3**3-9*g3**2+6*g3-1)), -3*(2*g3**2-4*g3+1)**2/(4*(3*g3**3-9*g3**2+6*g3-1)), g3]]),
     np.array([[0,0,0],[1/2,0,0],[0,3/4,0]]),
     np.array([(4*g3-1)/(4*(3*g3**3-9*g3**2+6*g3-1)), -3*(2*g3**2-4*g3+1)**2/(4*(3*g3**3-9*g3**2+6*g3-1)), g3]),
     np.array([2/9,1/3,4/9]),
     lambda lam, M: np.array([[(M+g3-1)/M, 0,0],[(g3**3*(12*M**2-36*M+18)+g3**2*(-36*M**2+108*M-42)+g3*(24*M**2-60*M+21)-4*M**2+9*M-3)/(9*M*(2*g3**2-4*g3+1)**2), -4*(M-3*g3)*(3*g3**3-9*g3**2+6*g3-1)/(9*(2*g3**2-4*g3+1)**2), 0],[2/9,1/3,4/9]]) if lam == M else np.array([[g3+lam-1, 0, 0],[(6*lam*g3**2-12*lam*g3+3*g3+3*lam-1)/(3*(2*g3**2-4*g3+1)),0,0],[lam,0,0]])/M,
     lambda lam, M: np.array([[0,0,0],[1/2,0,0],[-3*(12*g3**3+6*M*g3**2-18*g3**2-12*M*g3+6*g3+3*M-1)/(32*(3*g3**3-9*g3**2+6*g3-1)), 9*(M+6*g3-3)*(2*g3**2-4*g3+1)/(32*(3*g3**3-9*g3**2+6*g3-1)),0]]))
mr_ex5_ex5 = Multirate(np.array([[0,0,0,0,0],[2/5,0,0,0,0],[-3/20,3/4,0,0,0],[19/44,-15/44,10/11,0,0],[11/72,25/72,25/72,11/72,0]]),
     np.array([[0,0,0,0,0],[2/5,0,0,0,0],[-3/20,3/4,0,0,0],[19/44,-15/44,10/11,0,0],[11/72,25/72,25/72,11/72,0]]),
     np.array([11/72, 25/72, 25/72, 11/72, 0]),
     np.array([11/72, 25/72, 25/72, 11/72, 0]),
     lambda lam, M: np.array([[0,0,0,0,0],
                              [2/(5*M),0,0,0,0],
                              [3*(10*M**3-30*M**2+22*M-1)/(20*M*(3*M-4)), -3*(2*M**3-6*M**2+2*M+3)/(4*M*(3*M-4)), 0, 0, 0],
                              [0, 3*(10*M**3-50*M**2+116*M-83)/(22*M*(3*M-4)), (-30*M**3+150*M**2-282*M+161)/(22*M*(3*M-4)),0,0], [11/72/M, 25/72/M, 25/72/M,11/72/M,0]]) if lam == 1 else np.array([[11*(lam-1)/72/M, 25*(lam-1)/(72*M), 25*(lam-1)/(72*M), 11*(lam-1)/(72*M), 0], [(-450*M**2+956*lam*M-497*M-956*lam+776)/(450*(M-1)*M), (450*M**2-506*lam*M+227*M+506*lam-506)/(450*(M-1)*M), 0,0,0], [(-900*M**3+1239*lam*M**2+2217*M**2-2891*lam*M-97*M+1652*lam-1562)/(600*M*(3*M**2-7*M+4)), (900*M**3+561*lam*M**2-2937*M**2-1309*lam*M+1777*M+748*lam+602)/(600*M*(3*M**2-7*M+4)),0,0,0],[0, (-90*M**3+99*lam*M**2+197*M**2-231*lam*M-205*M+132*lam+117)/(22*M*(3*M**2-7*M+4)), (3240*M**3-825*lam*M**2-7455*M**2+1925*lam*M+8227*M-1100*lam-4696)/(792*M*(3*M**2-7*M+4)), -11*(lam-1)/(72*M),0], [11*lam/(72*M), 25*lam/(72*M), 25*lam/(72*M), 11*lam/(72*M), 0]]),
     lambda lam, M: np.array([[0,0,0,0,0],[2*M/5,0,0,0,0],[-3/20*M*(5*M-4), 3*M**2/4,0,0,0],[1/44*M*(56*M**2-81*M+44), -5/44*M**2*(16*M-13), -5/11*(M-3)*M**2, (M-1)*M**2,0],[11/72,25/72,25/72,11/72,0]]) if lam == 1 else np.array([[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[11/72,25/72,25/72,11/72,0]]))
mr_ex6_im5 = Multirate(
     np.array([[0,0,0,0,0,0],[1/4,0,0,0,0,0],[3/32,9/32,0,0,0,0],[1932/2197,-7200/2197,7296/2197,0,0,0],[439/216,-8,3680/513,-845/4104,0,0],[-8/27,2,-3544/2565,1859/4104,-11/40,0]]),
     np.array([[1/4,0,0,0,0],
               [13/20,1/4,0,0,0],
               [580/1287,-175/5148,1/4,0,0],
               [12698/37375,-201/2990,891/11500,1/4,0],
               [944/1365,-400/819,99/35,-575/252,1/4]]),
     np.array([25/216,0,1408/2565,2197/4104,-1/5,0]),
     np.array([944/1365,-400/819,99/35,-575/252,1/4]),
     lambda lam, M: np.array([[(lam-1)/M,0,0,0,0],[(4*lam-3)/(4*M),0,0,0,0],[(45*M**3-90*M**2+551*lam*M-335*M+90*lam-90)/(416*M**2), -15*(3*M**3-6*M**2+9*lam*M-5*M+6*lam-6)/(416*M**2),0,0,0],[(1440*M**3-2880*M**2+6517*lam*M-3709*M-3960*lam+3960)/(2197*M**2), -60*(24*M**3-48*M**2+72*lam*M-59*M-66*lam+66)/(2197*M**2),0,0,0], [(560*M**3-362*M**2+386*lam*M-529*M-1155*lam+1155)/(273*M**2), -5*(672*M**3-2439*M**2+4046*lam*M-2590*M-1386*lam+1386)/(1638*M**2), -33*(11*M-14*lam+7)/(28*M), (575*(3*M-2*lam+1)) / (252*M), 0], [0,0, (160*M**3-109*M**2-300*M+165)/(32*M**2), (-160*M**3+109*M**2+32*lam*M+284*M-165)/(32*M**2),0]]),
     lambda lam, M: np.array([[M/4, 0,0,0,0,0],
                              [-1/100*M*(169*M-90),169*M**2/100,0,0,0,0],
                              [-1/198*M*(155*M-132), 155*M**2/198,0,0,0,0],
                              [-1/920*M*(497*M-552), 14*M**2/23, -896*M**2/10925, 1183*M**2/87400,0,0], [25/216,0,1408/2565,2197/4104,-1/5,0]]) if lam == 1 else np.array([[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[0,0,0,0,0,0],[25/216,0,1408/2565,2197/4104,-1/5,0]]))
mr_im6_ex4 = Multirate(np.array([[191/1000,0,0,0,0,0],[209/1000,191/1000,0,0,0,0],[8466728223/12920014250,-12729769579/51680057000, 191/1000,0,0,0],[102093693512533448034070599559771/222819131395744425631166002057000,-17248151203963882893894684614/68098756539041694875050734125,783289327941232988291717301/1938400447113914098574736860,191/1000,0,0],[1837041228720545025825201951582239534326/2195453146940870392428577778808091404375,-12181532573386077454382848427541846123/17628427274186874088578235825358750000,4528991149246665992465958589958885289/8624433917634487442857055565277187500,83750160542686187/606298988321250000,191/1000,0],[2288000/4732539,-2203/14250,247273/613500,30767/152250,-1/8,191/1000]]),
     np.array([[0,0,0,0],[2/5,0,0,0],[-3/20,3/4,0,0],[19/44,-15/44,10/11,0]]),
     np.array([2288000/4732539, -2203/14250, 247273/613500, 30767/152250, -1/8, 191/1000]),
     np.array([11/72,25/72,25/72,11/72]),
     lambda lam, M: np.array([[(1000*lam-809)/(1000*M), 0,0,0],
                              [(5*lam-3)/(5*M),0,0,0],
                              [(5*lam-2)/(5*M),0,0,0],
                              [(5*lam-1)/(5*M),0,0,0],
                              [lam/M,0,0,0],
                              [lam/M,0,0,0]]) \
     if lam != M else np.array([[(1000*M-809)/(1000*M),0,0,0],
                                [(11380195070453 *M**3-18408895671188* M**2+14477055081282* M-5016867120000)/(8361445200000* M), -(209* (54450694117* M**2-88080840532* M+29261291298))/8361445200000, 0, 0],
                                [(-45728475609635251* M**3-421177045491040004* M**2+701106234145018506* M-206755963893960000)/(516889909734900000* M),(409*(111805563837739* M**2+1029772727361956* M-450406661149434))/516889909734900000 ,0 , 0],
                                [(313252304037186017* M**3-457232580001772932* M**2+265208779590977398* M-51451316893680000)/(257256584468400000* M), -(203*(2350256923212739* M**2-2188535491388044* M-533759817986934))/257256584468400000, (203*(885000 *M**2+70000* M-628199))/282071856, 0],
                                [0,(-885000* M**2+885000* M+831041)/859500, (590000* M**2-590000* M-114791)/573000,2101/9000],
                                [11/72,25/72,25/72,11/72]]),
     lambda lam, M: np.array([[0,0,0,0,0,0],[2/5,0,0,0,0,0],[3*(500*M-409)/1045,-6*(250*M-309)/1045,0,0,0,0],[(547008637842659863-386281780255161444 *M)/152025995207353729,(3 *(2856036493343421* M-3906629787402737))/2288803570033750,  -(741819* (1303514627* M-4489322119))/2239523110391875, -(8391*( (18565412379* M-24937027363)))/202099662773750,0,0]]))

class TestExact:
    
    @pytest.mark.parametrize("method", [mr_ex2_im2, mr_im2_ex2,mr_ex2_ex2])
    def test_order_2(self,method):
        A1 = np.array([1,0])
        B1 = -0.5
        def f1(t,y):
            return (A1 * t + B1)
        A2 = np.array([1,5])
        B2 = 1
        def f2(t,y):
            return (A2 * t + B2)
        y0 = np.array([0,0.5])
        t0 = 0
        tf = 2
        dt = 0.1
        yf = pytest.approx((A1+A2)*tf**2/2 + (B1+B2)*tf + y0)
        assert (multirate_solve(y0,t0,dt,tf,method,2,f1,f2) == yf)
        assert (multirate_solve(y0,t0,dt,tf,method,4,f1,f2) == yf)

    @pytest.mark.parametrize("method", [mr_ex3_ex3,mr_ex3_im3,mr_im3_ex3])
    def test_order_3(self,method):
        A1 = np.array([1,0])
        B1 = -0.5
        C1 = np.array([2,3])
        def f1(t,y):
            return (A1 * t*t + B1*t+C1)
        A2 = np.array([1,5])
        B2 = 1
        C2 = np.array([1,0])
        def f2(t,y):
            return (A2 * t*t + B2*t+C2)
        y0 = np.array([0,0.5])
        t0 = 0
        tf = 2
        dt = 0.1
        yf = pytest.approx((A1+A2)*tf**3/3 + (B1+B2)*tf**2/2 + (C1+C2)*tf + y0)
        assert (multirate_solve(y0,t0,dt,tf,method,2,f1,f2) == yf)
        assert (multirate_solve(y0,t0,dt,tf,method,4,f1,f2) == yf)

    @pytest.mark.parametrize("method", [mr_ex4_ex4,mr_ex5_ex5,mr_ex6_im5,mr_im6_ex4])
    def test_order_4(self,method):
        A1 = np.array([1,0])
        B1 = -0.5
        C1 = np.array([2,3])
        D1 = np.array([-1,2])
        def f1(t,y):
            return (A1 * t**3 + B1*t**2+C1*t+D1)
        A2 = np.array([1,5])
        B2 = 1
        C2 = np.array([1,0])
        D2 = np.array([2,4])
        def f2(t,y):
            return (A2 * t**3 + B2*t**2+C2*t+D2)
        y0 = np.array([0,0.5])
        t0 = 0
        tf = 2
        dt = 0.1
        yf = pytest.approx((A1+A2)*tf**4/4 + (B1+B2)*tf**3/3 + (C1+C2)*tf**2/2 + (D1+D2)*tf + y0)
        assert (multirate_solve(y0,t0,dt,tf,method,2,f1,f2) == yf)
        assert (multirate_solve(y0,t0,dt,tf,method,4,f1,f2) == yf)

class TestOrder:
    lambdaf = -10
    lambdas = -1
    eps = 0.1
    alpha = 1
    beta = 20

    arr =np.array([[lambdaf, (1-eps)/alpha * (lambdaf - lambdas)], [-alpha*eps*(lambdaf-lambdas), lambdas]])
    def fs(t, y):
        u = y[0]
        v = y[1]
        result = TestOrder.arr @ np.array([(-3 + u**2 - np.cos(TestOrder.beta*t))/(2*u), (-2+v**2-np.cos(t))/(2*v)]) - np.array([TestOrder.beta*np.sin(TestOrder.beta*t)/(2*u), np.sin(t)/(2*v)])
        result[0] = 0
        return result

    def ff(t, y):
        u = y[0]
        v = y[1]
        result = TestOrder.arr @ np.array([(-3 + u**2 - np.cos(TestOrder.beta*t))/(2*u), (-2+v**2-np.cos(t))/(2*v)]) - np.array([TestOrder.beta*np.sin(TestOrder.beta*t)/(2*u), np.sin(t)/(2*v)])
        result[1] = 0
        return result
    t0 = 0
    tf = 5*np.pi/2
    y0 = np.array([2, 3**0.5])

    yf = np.array([np.sqrt(3+np.cos(beta*tf)), np.sqrt(2+np.cos(tf))])

    @pytest.mark.parametrize("method,order,M,dts,name", [(mr_ex2_ex2,2,4,[tf/64,tf/128, tf/256],"mr_ex2_ex2"),
                                                  (mr_ex2_im2,2,2,[tf/128,tf/256, tf/512],"mr_ex2_im2"),
                                                  (mr_im2_ex2,2,4,[tf/128,tf/256, tf/512],"mr_im2_ex2"),
                                                  (mr_ex3_ex3,3,2,[tf/128,tf/256, tf/512],"mr_ex3_ex3"),
                                                  (mr_ex3_im3,3,2,[tf/64,tf/128, tf/256],"mr_ex3_im3"),
                                                  (mr_im3_ex3,3,8,[tf/64,tf/128, tf/256],"mr_im3_ex3"),
                                                  (mr_ex4_ex4,4,4,[tf/128, tf/200,tf/250],"mr_ex4_ex4"),
                                                  (mr_ex5_ex5,4,4,[tf/128, tf/200,tf/250],"mr_ex5_ex5"),
                                                  (mr_im6_ex4,4,16,[tf/250,tf/300],"mr_im6_ex4")])
    def test_order(self,method,order,M,dts,name):
        for dt in dts:#[dt0,dt0/2,dt0/4]:
            assert np.log2(np.linalg.norm(multirate_solve(TestOrder.y0,TestOrder.t0,dt,TestOrder.tf,method,M,TestOrder.fs,TestOrder.ff)-TestOrder.yf) / np.linalg.norm(multirate_solve(TestOrder.y0,TestOrder.t0,dt/2,TestOrder.tf,method,M,TestOrder.fs,TestOrder.ff)-TestOrder.yf)) == pytest.approx(order, abs=0.4, rel=0.1)

